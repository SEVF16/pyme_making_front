<div class="pos-sale-form-container">
  <div class="form-header">
    <div class="header-left">
      <app-button-lib
        [configuration]="backButtonConfig"
        (buttonClick)="goBack()"
      />
      <div class="header-info">
        <h1>Nueva Venta POS</h1>
        <p>Crea una nueva venta en el punto de venta</p>
      </div>
    </div>
  </div>

  @if (error()) {
    <div class="alert alert-error">
      {{ error() }}
    </div>
  }

  <form [formGroup]="saleForm" (ngSubmit)="createSale()">
    <!-- Información de Pago -->
    <div class="form-section">
      <h2 class="section-title">Información de Pago</h2>
      <div class="form-grid">
        <div class="form-field">
          <label for="paymentMethod">Método de Pago *</label>
          <select
            id="paymentMethod"
            formControlName="paymentMethod"
            class="form-input"
          >
            @for (method of paymentMethods; track method.value) {
              <option [value]="method.value">{{ method.label }}</option>
            }
          </select>
        </div>

        <div class="form-field">
          <label for="transactionReference">Referencia de Transacción</label>
          <input
            type="text"
            id="transactionReference"
            formControlName="transactionReference"
            class="form-input"
            placeholder="Ej: Número de voucher"
          />
        </div>

        <div class="form-field full-width">
          <label for="notes">Notas</label>
          <textarea
            id="notes"
            formControlName="notes"
            class="form-input"
            rows="2"
            placeholder="Notas adicionales sobre la venta"
          ></textarea>
        </div>
      </div>
    </div>

    <!-- Items de la Venta -->
    <div class="form-section">
      <div class="section-header">
        <h2 class="section-title">Items de la Venta</h2>
        <button
          type="button"
          (click)="addItem()"
          class="add-item-button"
        >
          <lucide-angular [img]="PlusIcon" [size]="18"></lucide-angular>
          Agregar Item
        </button>
      </div>

      <div class="items-container">
        @for (item of items.controls; track $index; let i = $index) {
          <div class="item-card" [formGroup]="item">
            <div class="item-header">
              <span class="item-number">Item #{{ i + 1 }}</span>
              @if (items.length > 1) {
                <button
                  type="button"
                  (click)="removeItem(i)"
                  class="remove-item-button"
                  title="Eliminar item"
                >
                  <lucide-angular [img]="Trash2Icon" [size]="18"></lucide-angular>
                </button>
              }
            </div>

            <div class="item-grid">
              <div class="form-field span-2">
                <label>Descripción *</label>
                <input
                  type="text"
                  formControlName="description"
                  class="form-input"
                  placeholder="Descripción del producto/servicio"
                />
              </div>

              <div class="form-field">
                <label>SKU</label>
                <input
                  type="text"
                  formControlName="sku"
                  class="form-input"
                  placeholder="Código SKU"
                />
              </div>

              <div class="form-field">
                <label>Cantidad *</label>
                <input
                  type="number"
                  formControlName="quantity"
                  class="form-input"
                  min="1"
                  step="1"
                />
              </div>

              <div class="form-field">
                <label>Precio Unitario *</label>
                <input
                  type="number"
                  formControlName="unitPrice"
                  class="form-input"
                  min="0"
                  step="100"
                />
              </div>

              <div class="form-field">
                <label>Descuento %</label>
                <input
                  type="number"
                  formControlName="discountPercentage"
                  class="form-input"
                  min="0"
                  max="100"
                  step="1"
                />
              </div>

              <div class="form-field">
                <label>Tasa IVA %</label>
                <input
                  type="number"
                  formControlName="taxRate"
                  class="form-input"
                  min="0"
                  max="100"
                  step="1"
                />
              </div>
            </div>

            <div class="item-totals">
              <div class="total-row">
                <span>Subtotal:</span>
                <span class="total-value">{{ formatCurrency(getItemSubtotal(i)) }}</span>
              </div>
              <div class="total-row">
                <span>Descuento:</span>
                <span class="total-value">-{{ formatCurrency(getItemDiscount(i)) }}</span>
              </div>
              <div class="total-row highlight">
                <span>Total Item:</span>
                <span class="total-value">{{ formatCurrency(getItemTotal(i)) }}</span>
              </div>
            </div>
          </div>
        }
      </div>
    </div>

    <!-- Resumen de Totales -->
    <div class="totals-section">
      <h2 class="section-title">Resumen de Venta</h2>
      <div class="totals-grid">
        <div class="total-row">
          <span class="total-label">Subtotal:</span>
          <span class="total-value">{{ formatCurrency(totals().subtotal) }}</span>
        </div>
        <div class="total-row">
          <span class="total-label">Descuentos:</span>
          <span class="total-value">-{{ formatCurrency(totals().discountTotal) }}</span>
        </div>
        <div class="total-row">
          <span class="total-label">IVA:</span>
          <span class="total-value">{{ formatCurrency(totals().taxTotal) }}</span>
        </div>
        <div class="total-row total-final">
          <span class="total-label">Total a Pagar:</span>
          <span class="total-value">{{ formatCurrency(totals().total) }}</span>
        </div>
        <div class="total-row payment-row">
          <label for="amountReceived" class="total-label">Monto Recibido:</label>
          <input
            type="number"
            id="amountReceived"
            formControlName="amountReceived"
            class="payment-input"
            min="0"
            step="100"
            placeholder="0"
          />
        </div>
        <div class="total-row change-row">
          <span class="total-label">Vuelto:</span>
          <span class="total-value">{{ formatCurrency(change()) }}</span>
        </div>
      </div>
    </div>

    <!-- Acciones -->
    <div class="form-actions">
      <app-button-lib
        [configuration]="backButtonConfig"
        (buttonClick)="goBack()"
      />
      <app-button-lib
        [configuration]="saveButtonConfig"
        [disabled]="saleForm.invalid || loading()"
        (buttonClick)="createSale()"
      />
    </div>
  </form>

  @if (loading()) {
    <div class="loading-overlay">
      <div class="spinner"></div>
      <p>Procesando venta...</p>
    </div>
  }
</div>
